<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Test Page</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .test-section { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 5px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }
        button:hover { background: #0056b3; }
        .result { background: #d4edda; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #f8d7da; }
        pre { background: #e9ecef; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ OAuth Flow Test</h1>
    
    <div class="test-section">
        <h2>Test OAuth Flow</h2>
        <p>This page helps test the OAuth flow with the mock server</p>
        <button onclick="startOAuthFlow()">Start OAuth Flow</button>
        <button onclick="checkForToken()">Check for Token in URL</button>
        <button onclick="clearResults()">Clear Results</button>
        
        <div id="results"></div>
    </div>

    <script>
        function startOAuthFlow() {
            const clientId = 'oauth-test-page';
            const scope = 'admin';
            const redirectUri = encodeURIComponent(window.location.href);
            const state = 'test-' + Math.random().toString(36).substr(2, 8);
            
            const oauthUrl = `http://localhost:3001/contao-manager.phar.php/#oauth?response_type=token&scope=${scope}&client_id=${clientId}&redirect_uri=${redirectUri}&state=${state}`;
            
            showResult('Starting OAuth flow...', false);
            showResult('Redirect URL: ' + oauthUrl, false);
            
            // Save state for verification
            localStorage.setItem('oauth_state', state);
            
            // Redirect to OAuth endpoint
            window.location.href = oauthUrl;
        }
        
        function checkForToken() {
            const hash = window.location.hash;
            
            if (!hash) {
                showResult('No hash fragment found in URL', true);
                return;
            }
            
            showResult('Hash fragment found: ' + hash, false);
            
            // Handle the case where there might be a path fragment before the token parameters
            let paramString = hash.substring(1); // Remove #
            
            // If there's already a hash fragment (like #token), look for the second part
            if (paramString.includes('#')) {
                const parts = paramString.split('#');
                paramString = parts[parts.length - 1]; // Get the last part after the final #
                showResult('Multiple hash fragments detected, using: #' + paramString, false);
            }
            
            // Parse the parameters
            const params = new URLSearchParams(paramString);
            
            const accessToken = params.get('access_token');
            const tokenType = params.get('token_type');
            const expiresIn = params.get('expires_in');
            const scope = params.get('scope');
            const state = params.get('state');
            const error = params.get('error');
            
            if (error) {
                showResult('OAuth Error: ' + error, true);
                const errorDescription = params.get('error_description');
                if (errorDescription) {
                    showResult('Error Description: ' + errorDescription, true);
                }
                return;
            }
            
            if (!accessToken) {
                showResult('ERROR: access_token parameter is missing from response!', true);
                showResult('Available parameters: ' + Array.from(params.keys()).join(', '), true);
                return;
            }
            
            showResult('‚úÖ OAuth Success!', false);
            showResult('Access Token: ' + accessToken, false);
            showResult('Token Type: ' + tokenType, false);
            showResult('Expires In: ' + expiresIn + ' seconds', false);
            showResult('Scope: ' + scope, false);
            showResult('State: ' + state, false);
            
            // Verify state
            const savedState = localStorage.getItem('oauth_state');
            if (savedState === state) {
                showResult('‚úÖ State verification passed', false);
            } else {
                showResult('‚ùå State verification failed (CSRF protection)', true);
            }
            
            // Test API call with token
            testSessionValidation(accessToken);
            testApiCall(accessToken);
        }
        
        async function testSessionValidation(token) {
            try {
                const response = await fetch('http://localhost:3001/api/session', {
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('‚úÖ Session validation successful', false);
                    showResult('Session Response: ' + JSON.stringify(data, null, 2), false);
                } else {
                    showResult('‚ùå Session validation failed: ' + response.status + ' ' + response.statusText, true);
                    const errorText = await response.text();
                    showResult('Error details: ' + errorText, true);
                }
            } catch (error) {
                showResult('‚ùå Session validation error: ' + error.message, true);
            }
        }
        
        async function testApiCall(token) {
            try {
                const response = await fetch('http://localhost:3001/api/server/self-update', {
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('‚úÖ API call successful with token', false);
                    showResult('API Response: ' + JSON.stringify(data, null, 2), false);
                } else {
                    showResult('‚ùå API call failed: ' + response.status + ' ' + response.statusText, true);
                }
            } catch (error) {
                showResult('‚ùå API call error: ' + error.message, true);
            }
        }
        
        function showResult(message, isError) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = isError ? 'result error' : 'result';
            div.innerHTML = '<pre>' + message + '</pre>';
            results.appendChild(div);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        // Auto-check for token when page loads
        window.onload = function() {
            if (window.location.hash) {
                showResult('Page loaded with hash fragment, checking for token...', false);
                checkForToken();
            } else {
                showResult('Ready to test OAuth flow. Make sure the mock server is running on port 3001.', false);
            }
        };
    </script>
</body>
</html>